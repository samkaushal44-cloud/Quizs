let questions = [];
let index = 0;
let coins = 0;
let time = 10;
let timer;
let answered = false;

// DOM
const qEl = document.getElementById("question");
const optEl = document.getElementById("options");
const coinsEl = document.getElementById("coins");
const progressEl = document.getElementById("progress");

// ðŸ”¹ FETCH QUESTIONS (INDIA GK)
async function loadQuestions() {
  try {
    const res = await fetch(
      "https://opentdb.com/api.php?amount=20&category=9&type=multiple"
    );
    const data = await res.json();

    questions = data.results.map(q => {
      const options = [...q.incorrect_answers];
      options.splice(Math.floor(Math.random() * 4), 0, q.correct_answer);

      return {
        question: decode(q.question),
        options: options.map(o => decode(o)),
        answer: options.indexOf(q.correct_answer)
      };
    });

    index = 0;
    showQuestion();
  } catch (e) {
    qEl.innerText = "No question found, retrying...";
    setTimeout(loadQuestions, 2000);
  }
}

// ðŸ”¹ SHOW QUESTION
function showQuestion() {
  clearInterval(timer);
  answered = false;

  if (index >= questions.length) {
    loadQuestions();
    return;
  }

  const q = questions[index];
  qEl.innerText = q.question;
  optEl.innerHTML = "";

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerText = opt;
    btn.onclick = () => selectAnswer(i);
    optEl.appendChild(btn);
  });

  time = 10;
  progressEl.style.width = "100%";
  startTimer();
}

// ðŸ”¹ TIMER
function startTimer() {
  timer = setInterval(() => {
    time--;
    progressEl.style.width = (time * 10) + "%";

    if (time <= 0) {
      clearInterval(timer);
      revealCorrect();
    }
  }, 1000);
}

// ðŸ”¹ ANSWER CLICK
function selectAnswer(i) {
  if (answered) return;
  answered = true;
  clearInterval(timer);

  const correct = questions[index].answer;
  const buttons = optEl.querySelectorAll("button");

  buttons[correct].classList.add("correct");

  if (i === correct) {
    coins += 10;
    coinsEl.innerText = "Coins: " + coins;
  } else {
    buttons[i].classList.add("wrong");
  }

  setTimeout(nextQuestion, 2000);
}

// ðŸ”¹ TIMEOUT ANSWER
function revealCorrect() {
  if (answered) return;
  answered = true;

  const correct = questions[index].answer;
  const buttons = optEl.querySelectorAll("button");
  buttons[correct].classList.add("correct");

  setTimeout(nextQuestion, 2000);
}

// ðŸ”¹ NEXT QUESTION
function nextQuestion() {
  index++;
  showQuestion();
}

// ðŸ”¹ WATCH AD (FAKE)
function watchAd() {
  alert("Ad watched! +20 Coins");
  coins += 20;
  coinsEl.innerText = "Coins: " + coins;
}

// ðŸ”¹ HTML DECODE
function decode(text) {
  const t = document.createElement("textarea");
  t.innerHTML = text;
  return t.value;
}

// ðŸ”¹ START
loadQuestions();
